<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#16a34a">
    <meta name="description" content="Muslim Mart - Product Management">
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'%3E%3Crect fill='%2316a34a' width='192' height='192'/%3E%3Ctext x='50%' y='50%' font-size='60' fill='%23ffffff' text-anchor='middle' dy='.3em'%3EüõçÔ∏è%3C/text%3E%3C/svg%3E">
    <title>Products - Muslim Mart</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="js/supabase.js"></script>
    <script src="js/data.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/pwa.js"></script>
</head>
<body class="bg-gray-50">
    <!-- Navigation Bar -->
    <nav class="bg-gradient-to-r from-green-600 to-blue-600 text-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center space-x-2">
                    <h1 class="text-2xl font-bold">üõçÔ∏è MUSLIM MART</h1>
                </div>
                <button onclick="logout()" class="bg-white text-green-600 px-4 py-2 rounded-lg font-semibold hover:bg-gray-100 transition">
                    Logout
                </button>
            </div>
        </div>
    </nav>

    <!-- Sidebar Navigation -->
    <div class="flex h-screen bg-gray-50" style="margin-top: -4rem; padding-top: 4rem;">
        <!-- Sidebar -->
        <aside class="w-64 bg-gray-900 text-white">
            <div class="p-6">
                <nav class="space-y-2">
                    <a href="index.html" class="flex items-center space-x-3 px-4 py-3 rounded-lg hover:bg-gray-800 font-semibold transition">
                        <span class="text-xl">üìä</span>
                        <span>Dashboard</span>
                    </a>
                    <a href="products.html" class="flex items-center space-x-3 px-4 py-3 rounded-lg bg-gradient-to-r from-green-500 to-blue-500 font-semibold hover:opacity-90 transition">
                        <span class="text-xl">üì¶</span>
                        <span>Products</span>
                    </a>
                    <a href="sales.html" class="flex items-center space-x-3 px-4 py-3 rounded-lg hover:bg-gray-800 font-semibold transition">
                        <span class="text-xl">üí≥</span>
                        <span>Sales / POS</span>
                    </a>
                    <a href="reports.html" class="flex items-center space-x-3 px-4 py-3 rounded-lg hover:bg-gray-800 font-semibold transition">
                        <span class="text-xl">üìà</span>
                        <span>Profit & Loss</span>
                    </a>
                </nav>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 overflow-auto">
            <div class="max-w-7xl mx-auto p-8">
                <!-- Page Header -->
                <div class="flex justify-between items-center mb-8">
                    <div>
                        <h2 class="text-3xl font-bold text-gray-900">Product Management</h2>
                        <p class="text-gray-600 mt-2">Manage inventory and product information</p>
                    </div>
                    <button onclick="openAddProductModal()" class="bg-gradient-to-r from-green-600 to-blue-600 text-white px-6 py-3 rounded-lg font-semibold hover:opacity-90 transition">
                        + Add Product
                    </button>
                </div>

                <!-- Filter Section -->
                <div class="bg-white rounded-lg shadow-md p-4 mb-6">
                    <div class="flex flex-col md:flex-row gap-4">
                        <input 
                            type="text" 
                            id="searchInput" 
                            placeholder="Search by product name..." 
                            class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 outline-none"
                        >
                        <select id="categoryFilter" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 outline-none">
                            <option value="">All Categories</option>
                        </select>
                    </div>
                </div>

                <!-- Products Table -->
                <div class="bg-white rounded-lg shadow-md overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="min-w-full text-left">
                            <thead class="bg-gray-100 border-b-2 border-gray-300">
                                <tr>
                                    <th class="px-6 py-4 font-semibold text-gray-700">Product Name</th>
                                    <th class="px-6 py-4 font-semibold text-gray-700">Category</th>
                                    <th class="px-6 py-4 font-semibold text-gray-700 text-center">Quantity</th>
                                    <th class="px-6 py-4 font-semibold text-gray-700 text-right">Buy Price</th>
                                    <th class="px-6 py-4 font-semibold text-gray-700 text-right">Sell Price</th>
                                    <th class="px-6 py-4 font-semibold text-gray-700 text-center">Status</th>
                                    <th class="px-6 py-4 font-semibold text-gray-700 text-center">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="productsTable" class="divide-y">
                                <tr><td colspan="7" class="px-6 py-4 text-center text-gray-500">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Add/Edit Product Modal -->
    <div id="productModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-2xl max-w-md w-full max-h-96 overflow-y-auto">
            <div class="p-6 border-b-2 border-gray-200 sticky top-0 bg-white">
                <h3 id="modalTitle" class="text-xl font-bold text-gray-900">Add Product</h3>
            </div>

            <form id="productForm" class="p-6 space-y-4">
                <div>
                    <label class="block text-gray-700 font-semibold mb-2">Product Name</label>
                    <input type="text" id="productName" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 outline-none">
                </div>

                <div>
                    <label class="block text-gray-700 font-semibold mb-2">Category</label>
                    <select id="productCategory" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 outline-none">
                        <option value="">Select Category</option>
                    </select>
                </div>

                <div>
                    <label class="block text-gray-700 font-semibold mb-2">Sub Category</label>
                    <select id="productSubcategory" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 outline-none">
                        <option value="">Select Sub Category</option>
                    </select>
                </div>

                <div>
                    <label class="block text-gray-700 font-semibold mb-2">Buy Price (Rs.)</label>
                    <input type="number" id="buyPrice" required min="0" step="0.01" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 outline-none">
                </div>

                <div>
                    <label class="block text-gray-700 font-semibold mb-2">Sell Price (Rs.)</label>
                    <input type="number" id="sellPrice" required min="0" step="0.01" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 outline-none">
                </div>

                <div>
                    <label class="block text-gray-700 font-semibold mb-2">Quantity</label>
                    <input type="number" id="quantity" required min="1" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 outline-none">
                </div>

                <div>
                    <label class="block text-gray-700 font-semibold mb-2">Minimum Stock</label>
                    <input type="number" id="minStock" required min="1" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 outline-none">
                </div>

                <div class="flex gap-3 pt-4">
                    <button type="button" onclick="closeProductModal()" class="flex-1 bg-gray-300 text-gray-900 px-4 py-2 rounded-lg font-semibold hover:bg-gray-400 transition">
                        Cancel
                    </button>
                    <button type="submit" class="flex-1 bg-gradient-to-r from-green-600 to-blue-600 text-white px-4 py-2 rounded-lg font-semibold hover:opacity-90 transition">
                        Save
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const authManager = new AuthManager();
        let currentEditId = null;
        const categories = dataManager.getData('categories') || {};

        // Populate category select
        function populateCategories() {
            const select = document.getElementById('productCategory');
            const filterSelect = document.getElementById('categoryFilter');
            select.innerHTML = '<option value="">Select Category</option>';
            filterSelect.innerHTML = '<option value="">All Categories</option>';

            Object.keys(categories).forEach(cat => {
                const option1 = document.createElement('option');
                option1.value = cat;
                option1.textContent = cat.replace(/_/g, ' ');
                select.appendChild(option1);

                const option2 = document.createElement('option');
                option2.value = cat;
                option2.textContent = cat.replace(/_/g, ' ');
                filterSelect.appendChild(option2);
            });
        }

        // Update subcategories based on selected category
        document.getElementById('productCategory').addEventListener('change', function() {
            const subcategorySelect = document.getElementById('productSubcategory');
            const category = this.value;
            subcategorySelect.innerHTML = '<option value="">Select Sub Category</option>';

            if (category && categories[category]) {
                categories[category].forEach(sub => {
                    const option = document.createElement('option');
                    option.value = sub;
                    option.textContent = sub;
                    subcategorySelect.appendChild(option);
                });
            }
        });

        // Load products table
        function loadProducts() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const categoryFilter = document.getElementById('categoryFilter').value;
            let products = dataManager.getProducts();

            if (searchTerm) {
                products = products.filter(p => p.name.toLowerCase().includes(searchTerm));
            }

            if (categoryFilter) {
                products = products.filter(p => p.category === categoryFilter);
            }

            const tableBody = document.getElementById('productsTable');
            tableBody.innerHTML = '';

            if (products.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="7" class="px-6 py-4 text-center text-gray-500">No products found</td></tr>';
                return;
            }

            products.forEach(product => {
                const status = product.quantity <= product.minStock ? 'Low Stock' : 'In Stock';
                const statusColor = product.quantity <= product.minStock ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800';
                const profit = product.sellPrice - product.buyPrice;

                const row = document.createElement('tr');
                row.classList.add('hover:bg-gray-50');
                row.innerHTML = `
                    <td class="px-6 py-4 font-semibold text-gray-900">${product.name}</td>
                    <td class="px-6 py-4 text-gray-700">${product.category.replace(/_/g, ' ')}</td>
                    <td class="px-6 py-4 text-center text-gray-700">${product.quantity}</td>
                    <td class="px-6 py-4 text-right text-gray-700">Rs. ${product.buyPrice.toLocaleString()}</td>
                    <td class="px-6 py-4 text-right font-semibold text-green-600">Rs. ${product.sellPrice.toLocaleString()}</td>
                    <td class="px-6 py-4 text-center">
                        <span class="px-3 py-1 rounded-full text-sm font-semibold ${statusColor}">${status}</span>
                    </td>
                    <td class="px-6 py-4 text-center space-x-2">
                        <button onclick="editProduct(${product.id})" class="bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600 transition">Edit</button>
                        <button onclick="deleteProduct(${product.id})" class="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600 transition">Delete</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        // Open add product modal
        function openAddProductModal() {
            currentEditId = null;
            document.getElementById('modalTitle').textContent = 'Add Product';
            document.getElementById('productForm').reset();
            document.getElementById('productModal').classList.remove('hidden');
        }

        // Edit product
        function editProduct(id) {
            const product = dataManager.getProductById(id);
            if (!product) return;

            currentEditId = id;
            document.getElementById('modalTitle').textContent = 'Edit Product';
            document.getElementById('productName').value = product.name;
            document.getElementById('productCategory').value = product.category;
            
            // Populate subcategories and set value
            document.getElementById('productCategory').dispatchEvent(new Event('change'));
            setTimeout(() => {
                document.getElementById('productSubcategory').value = product.subcategory;
            }, 0);

            document.getElementById('buyPrice').value = product.buyPrice;
            document.getElementById('sellPrice').value = product.sellPrice;
            document.getElementById('quantity').value = product.quantity;
            document.getElementById('minStock').value = product.minStock;

            document.getElementById('productModal').classList.remove('hidden');
        }

        // Close modal
        function closeProductModal() {
            document.getElementById('productModal').classList.add('hidden');
        }

        // Save product
        document.getElementById('productForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const productData = {
                name: document.getElementById('productName').value,
                category: document.getElementById('productCategory').value,
                subcategory: document.getElementById('productSubcategory').value,
                buyPrice: parseFloat(document.getElementById('buyPrice').value),
                sellPrice: parseFloat(document.getElementById('sellPrice').value),
                quantity: parseInt(document.getElementById('quantity').value),
                minStock: parseInt(document.getElementById('minStock').value)
            };

            if (currentEditId) {
                dataManager.updateProduct(currentEditId, productData);
            } else {
                dataManager.addProduct(productData);
            }

            closeProductModal();
            loadProducts();
        });

        // Delete product
        function deleteProduct(id) {
            if (confirm('Are you sure you want to delete this product?')) {
                dataManager.deleteProduct(id);
                loadProducts();
            }
        }

        // Search and filter
        document.getElementById('searchInput').addEventListener('input', loadProducts);
        document.getElementById('categoryFilter').addEventListener('change', loadProducts);

        // Logout
        function logout() {
            authManager.logout();
        }

        // Initialize
        window.addEventListener('load', () => {
            populateCategories();
            loadProducts();
        });
    </script>
</body>
</html>
